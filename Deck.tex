\documentclass[14pt]{beamer}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{listings}
\usepackage{themes/dbt}
\usepackage{textpos}
\lstset{language=csh, numbers=left, frame=single, breaklines=true, breakatwhitespace=false, basicstyle=\smaller, numberstyle=\small, basicstyle=\sffamily}

%\usetheme{Warsaw}
\title{The road to full containerization}
\institute{\includegraphics[width=3.5cm]{images/title_logo.png}}
\author{Wies≈Çaw Kielas}
\date{\today}

\defbeamertemplate*{title page}{customized}[1][]
{
  \usebeamercolor[fg]{title}
  \usebeamerfont{title}\inserttitle\par
  \bigskip
  \usebeamerfont{institute}\insertinstitute\par
  \bigskip
  \usebeamercolor[fg]{item}
  \usebeamerfont{author}\insertauthor\par
  \usebeamerfont{date}\insertdate\par
}

\newcommand{\imageframe}[2]{{
  \usebackgroundtemplate{\includegraphics[width=\paperwidth,height=\paperheight]
  {#1}}
  \begin{frame}{\vspace{-6pt}\usebeamercolor[fg]{item}\huge{#2}}
  \end{frame}
}}

\begin{document}
  \begin{frame}
    \maketitle
  \end{frame}

  \logo{\vspace{-6pt}\includegraphics[width=1.0cm]{images/logo.png}}

  \begin{frame}{Who am I~and what is this about?}
  \begin{itemize}
    \item About me
    \begin{itemize}
      \item DevOps engineer for Global App Testing since 2016
      \item IT professional since 2011
    \end{itemize}
    \bigskip
    \item About this presentation
    \begin{itemize}
      \item Quick introduction
      \item Technology stack
      \item The migration talk
    \end{itemize}
    \bigskip
    \item Things are moving fast!
  \end{itemize}
  \end{frame}

  % ---------------------------------- %

  \imageframe{images/ancient_history.jpg}{Ancient history}

  \begin{frame}{GAT infrastructure}
  \framesubtitle{The year is 2016}
  \centering
  \includegraphics[width=8cm]{images/opsworks_diagram.png}
  \end{frame}

  \begin{frame}{GAT infrastructure}
  \framesubtitle{Pain points explained}
  \begin{itemize}
    \item Long deployment times
    \item Uncertainty of success before starting
    \item Deployments caused downtime
    \item High cost
    \item Not automated
  \end{itemize}
  \end{frame}

  \begin{frame}{Gat infrastructure}
  \framesubtitle{What next?}
  \begin{itemize}
    \item Improve existing infrastructure
    \begin{itemize}
      \item Vendor lock-in
    \end{itemize}
    \bigskip
    \item Move to containers
    \begin{itemize}
      \item Save money
      \item Lessen configuration complexity
      \item Play with shiny new tools
    \end{itemize}
  \end{itemize}
  \end{frame}

  % ---------------------------------- %

  \imageframe{images/container_landscape.jpg}{The container landscape}

  \begin{frame}{Docker}
    \begin{columns}[c]
      \begin{column}{.3\textwidth}
          \includegraphics[width=3cm,height=3cm]{images/docker_logo.png}
      \end{column}
      \begin{column}{.7\textwidth}
        \begin{itemize}
          \item Container platform
          \item Lightweight virtual machines
          \item Packaging format
          \begin{itemize}
            \item Reproducible deployments
          \end{itemize}
        \end{itemize}
      \end{column}
    \end{columns}
  \end{frame}

  \begin{frame}{Kubernetes}
    \begin{columns}[c]
      \begin{column}{.3\textwidth}
          \includegraphics[width=3cm,height=3cm]{images/kubernetes_logo.png}
      \end{column}
      \begin{column}{.7\textwidth}
        \begin{itemize}
          \item Container orchestration
          \item Service discovery
          \item Persistent storage
          \item High availability
        \end{itemize}
      \end{column}
    \end{columns}
  \end{frame}

  \begin{frame}{Helm}
    \begin{columns}[c]
      \begin{column}{.3\textwidth}
          \includegraphics[width=3cm,height=3cm]{images/helm_logo.png}
      \end{column}
      \begin{column}{.7\textwidth}
        \begin{itemize}
          \item Package manager
          \item Configuration management
          \begin{itemize}
            \item Provides templates
          \end{itemize}
          \item Deployment management
        \end{itemize}
      \end{column}
    \end{columns}
  \end{frame}

  % ---------------------------------- %

  \imageframe{images/migrating_cranes.jpg}{Migrating to Kubernetes}

  \begin{frame}{Moving to Kubernetes on GKE}
  \framesubtitle{Why there?}
  \begin{itemize}
    \item Automated cluster deployment
    \item Management by Google
    \item Built in goodies:
    \begin{itemize}
      \item Integrated authentication
      \item Centralized logging
      \item Cluster monitoring
      \item Container registry
    \end{itemize}
  \end{itemize}
  \end{frame}

  \begin{frame}{Moving to Kubernetes on GKE}
  \framesubtitle{The journey}
  \begin{itemize}
    \item Docker images for applications
    \item CI pipeline modification
    \item Helm instead of Chef
    \begin{itemize}
      \item Change configuration generation
    \end{itemize}
  \end{itemize}
  \end{frame}

  \begin{frame}{Moving to Kubernetes on GKE}
  \framesubtitle{The actual move}
  \begin{itemize}
    \item Moving apps one by one
    \item Only API communication
    \begin{itemize}
      \item VPNs were helpful
    \end{itemize}
  \end{itemize}
  \end{frame}

  \begin{frame}{Moving to Kubernetes on GKE}
  \framesubtitle{The end result}
  \centering
  \includegraphics[width=8cm]{images/kubernetes_diagram.png}
%  \begin{itemize}
%    \item TODO: Diagram goes here
%    \item Deployment flow unchanged
%    \item Basic architecture stays the same
%  \end{itemize}
  \end{frame}

  \begin{frame}{Moving to Kubernetes on GKE}
  \framesubtitle{Pain points revisited}
  \begin{itemize}
    \item Long deployment times
    \begin{itemize}
      \item Down from 15 minutes to 1-2 minutes
    \end{itemize}
    \item Uncertainty of success before starting
    \begin{itemize}
      \item Using Docker as packaging worked
    \end{itemize}
    \item Deployments caused downtime
    \begin{itemize}
      \item No downtime deployments
    \end{itemize}
    \item High cost
    \begin{itemize}
      \item Lowered
    \end{itemize}
    \item Not automated
    \begin{itemize}
      \item Automated (after some time)
    \end{itemize}
  \end{itemize}
  \end{frame}

  \begin{frame}{Moving to Kubernetes on GKE}
  \framesubtitle{No happy end}
  \begin{itemize}
    \item Bugs!
    \begin{itemize}
      \item Nodes crashing due to misconfigured journalctl
      \item Frequent networking problems
    \end{itemize}
    \item Bad support
    \item Management by Google
    \begin{itemize}
      \item No way of accessing the API master machine
    \end{itemize}
    \item Inflexible configuration
    \begin{itemize}
      \item Not possible to turn on alpha features
      \item Not possible to change node configuration
    \end{itemize}
  \item Waiting for Kubernetes security updates
  \end{itemize}
  \end{frame}

  \imageframe{images/returning_cranes.jpg}{Migrating back to AWS}

  \begin{frame}{Moving to Kubernetes on AWS}
  \framesubtitle{Enter kops}
  \begin{columns}[c]
    \begin{column}{.3\textwidth}
      \includegraphics[width=4cm]{images/kops_logo.png}
    \end{column}
    \begin{column}{.7\textwidth}
      \begin{itemize}
        \item Cluster bootstrapping utility
        \item Lifecycle management
        \item Very flexible
      \end{itemize}
    \end{column}
  \end{columns}
  \end{frame}

  \begin{frame}{Moving to Kubernetes on AWS}
  \framesubtitle{New challenges}
  \begin{itemize}
    \item Missing parts
    \begin{itemize}
      \item Authentication integrated with the rest of their cloud - \textbf{PKI}
      \item Centralized logging - \textbf{Graylog}
      \item Cluster monitoring - \textbf{Prometheus and Grafana}
    \end{itemize}
    \item Moving stuff
    \begin{itemize}
      \item Container registry - \textbf{Amazon ECR}
      \item AWS and GKE load balancers behave differently
      \item Use EBS instead of Google disks
    \end{itemize}
  \end{itemize}
  \end{frame}

  \begin{frame}{Moving to Kubernetes on AWS}
  \framesubtitle{End result}
  \begin{itemize}
    \item It's stable!
    \bigskip
    \item Minor issues
    \begin{itemize}
      \item EBS volumes get stuck on mount
    \end{itemize}
  \end{itemize}
  \end{frame}

  \imageframe{images/questions.jpg}{Questions?}

\end{document}
